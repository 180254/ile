name: ile-laptop

networks:
  vnet:
    name: ile-base_vnet
    external: true

volumes:
  mosquitto_data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${ILE_DIR}/volume_mosquitto_laptop

  valkey_data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: ${ILE_DIR}/volume_valkey_laptop

services:
  mosquitto:
    build:
      context: ${ILE_DIR}/ile_mosquitto
      dockerfile: mosquitto.Dockerfile
      args:
        ILE_NONROOT_UID: ${ILE_NONROOT_UID}
        ILE_NONROOT_GID: ${ILE_NONROOT_GID}
      no_cache: false
      pull: true
    image: ile-laptop-mosquitto:0.0.1
    user: nonroot:nonroot
    restart: always
    networks:
      vnet:
        ipv4_address: 192.168.130.10
    ports:
      - "8883:8883" # MQTT over TLS
      - "9002:9002" # MQTT over WebSockets with TLS
    environment:
      - ILE_MQTT_USERNAME=${ILE_MQTT_USERNAME}
      - ILE_MQTT_PASSWORD=${ILE_MQTT_PASSWORD}
    volumes:
      - mosquitto_data:/mosquitto/data
      - ${ILE_DIR}/ile_mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ${PWD}/tls/${ILE_ENV}/ca.pem:/mosquitto/secrets/ca.crt:ro
      - ${PWD}/tls/${ILE_ENV}/laptop.pem:/mosquitto/secrets/server.crt:ro
      - ${PWD}/tls/${ILE_ENV}/laptop-key.pem:/mosquitto/secrets/server.key:ro
    logging:
      options:
        max-size: 10m
        max-file: 1
    healthcheck:
      test: >
        timeout -s 15 5
        mosquitto_sub
        -h localhost
        -p 8883
        --cafile /mosquitto/secrets/ca.crt
        --tls-version tlsv1.3
        --insecure
        -u ${ILE_MQTT_USERNAME}
        -P ${ILE_MQTT_PASSWORD}
        -t '$$SYS/broker/uptime'
        -C 1
        || exit 1
      interval: 30s
      timeout: 10s
      start_period: 20s
      retries: 3
    depends_on: [ ]
    deploy:
      restart_policy:
        condition: any
        delay: 5s
      resources:
        limits:
          cpus: '0.4'
        reservations:
          cpus: '0.3'
    labels:
      ile-autoheal: true

  valkey:
    build:
      context: ${ILE_DIR}/ile_valkey
      dockerfile: valkey.Dockerfile
      args:
        ILE_NONROOT_UID: ${ILE_NONROOT_UID}
        ILE_NONROOT_GID: ${ILE_NONROOT_GID}
      no_cache: false
      pull: true
    image: ile-laptop-valkey:0.0.1
    user: nonroot:nonroot
    restart: always
    networks:
      vnet:
        ipv4_address: 192.168.130.11
    ports:
      - "6379:6379"
    environment:
      - ILE_VALKEY_PASSWORD=${ILE_VALKEY_PASSWORD}
    volumes:
      - valkey_data:/valkey/data
      - ${ILE_DIR}/ile_valkey/valkey.conf.tmpl:/valkey/config/valkey.conf.tmpl:ro
      - ${PWD}/tls/${ILE_ENV}/ca.pem:/valkey/secrets/ca.crt:ro
      - ${PWD}/tls/${ILE_ENV}/laptop.pem:/valkey/secrets/server.crt:ro
      - ${PWD}/tls/${ILE_ENV}/laptop-key.pem:/valkey/secrets/server.key:ro
    logging:
      options:
        max-size: 10m
        max-file: 1
    healthcheck:
      test: >
        timeout -s 15 5
        valkey-cli -h localhost -p 6379 -a ${ILE_VALKEY_PASSWORD}
        --tls --insecure ping | grep -qaFi PONG
        || exit 1
      interval: 30s
      timeout: 10s
      start_period: 20s
      retries: 3
    depends_on: [ ]
    deploy:
      restart_policy:
        condition: any
        delay: 5s
      resources:
        limits:
          cpus: '0.4'
        reservations:
          cpus: '0.3'
    labels:
      ile-autoheal: true

  mqtt-ingestor:
    build:
      context: ${ILE_DIR}/ile_modules
      dockerfile: ile_modules.Dockerfile
      args:
        ILE_NONROOT_UID: ${ILE_NONROOT_UID}
        ILE_NONROOT_GID: ${ILE_NONROOT_GID}
      no_cache: false
      pull: true
    image: ile-laptop-mqtt-ingestor:0.0.1
    entrypoint: /bin/sh -c
    command:
      - /.venv/bin/python3 -m ile_modules.mqtt_ingestor
    user: nonroot:nonroot
    restart: always
    networks:
      vnet:
        ipv4_address: 192.168.130.12
    ports: [ ]
    environment:
      - ILE_DEBUG=${ILE_DEBUG}
      - ILE_VALKEY_HOST=192.168.130.11
      - ILE_VALKEY_PORT=6379
      - ILE_VALKEY_SSL=true
      - ILE_VALKEY_DB=0
      - ILE_VALKEY_PASSWORD=${ILE_VALKEY_PASSWORD}
      - ILE_MQTT_HOST=192.168.130.10
      - ILE_MQTT_SSL=true
      - ILE_MQTT_PORT=8883
      - ILE_MQTT_USERNAME=${ILE_MQTT_USERNAME}
      - ILE_MQTT_PASSWORD=${ILE_MQTT_PASSWORD}
    volumes: [ ]
    logging:
      options:
        max-size: 10m
        max-file: 1
    healthcheck:
      test: >
        timeout -s 15 5 true || exit 1
      interval: 30s
      timeout: 10s
      start_period: 20s
      retries: 3
    depends_on:
      mosquitto:
        condition: service_started
        restart: true
      valkey:
        condition: service_started
        restart: true
    deploy:
      restart_policy:
        condition: any
        delay: 5s
      resources:
        limits:
          cpus: '0.4'
        reservations:
          cpus: '0.3'
    labels:
      ile-autoheal: true

  payload-normalizer:
    build:
      context: ${ILE_DIR}/ile_modules
      dockerfile: ile_modules.Dockerfile
      args:
        ILE_NONROOT_UID: ${ILE_NONROOT_UID}
        ILE_NONROOT_GID: ${ILE_NONROOT_GID}
      no_cache: false
      pull: true
    image: ile-laptop-payload-normalizer:0.0.1
    entrypoint: /bin/sh -c
    command:
      - /.venv/bin/python3 -m ile_modules.payload_normalizer
    user: nonroot:nonroot
    restart: always
    networks:
      vnet:
        ipv4_address: 192.168.130.13
    ports: [ ]
    environment:
      - ILE_DEBUG=${ILE_DEBUG}
      - ILE_VALKEY_HOST=192.168.130.11
      - ILE_VALKEY_PORT=6379
      - ILE_VALKEY_SSL=true
      - ILE_VALKEY_DB=0
      - ILE_VALKEY_PASSWORD=${ILE_VALKEY_PASSWORD}
      - ILE_MQTT_HOST=192.168.130.10
      - ILE_MQTT_SSL=true
      - ILE_MQTT_PORT=8883
      - ILE_MQTT_USERNAME=${ILE_MQTT_USERNAME}
      - ILE_MQTT_PASSWORD=${ILE_MQTT_PASSWORD}
    volumes: [ ]
    logging:
      options:
        max-size: 10m
        max-file: 1
    healthcheck:
      test: >
        timeout -s 15 5 true || exit 1
      interval: 30s
      timeout: 10s
      start_period: 20s
      retries: 3
    depends_on:
      mosquitto:
        condition: service_started
        restart: true
      valkey:
        condition: service_started
        restart: true
    deploy:
      restart_policy:
        condition: any
        delay: 5s
      resources:
        limits:
          cpus: '0.4'
        reservations:
          cpus: '0.3'
    labels:
      ile-autoheal: true

  report-printer:
    build:
      context: ${ILE_DIR}/ile_modules
      dockerfile: ile_modules.Dockerfile
      args:
        ILE_NONROOT_UID: ${ILE_NONROOT_UID}
        ILE_NONROOT_GID: ${ILE_NONROOT_GID}
      no_cache: false
      pull: true
    image: ile-laptop-report-printer:0.0.1
    entrypoint: /bin/sh -c
    command:
      - /.venv/bin/python3 -m ile_modules.report_printer
    user: nonroot:nonroot
    restart: always
    networks:
      vnet:
        ipv4_address: 192.168.130.14
    ports: [ ]
    environment:
      - ILE_DEBUG=${ILE_DEBUG}
      - ILE_VALKEY_HOST=192.168.130.11
      - ILE_VALKEY_PORT=6379
      - ILE_VALKEY_SSL=true
      - ILE_VALKEY_DB=0
      - ILE_VALKEY_PASSWORD=${ILE_VALKEY_PASSWORD}
      - ILE_MQTT_HOST=192.168.130.10
      - ILE_MQTT_SSL=true
      - ILE_MQTT_PORT=8883
      - ILE_MQTT_USERNAME=${ILE_MQTT_USERNAME}
      - ILE_MQTT_PASSWORD=${ILE_MQTT_PASSWORD}
    volumes: [ ]
    logging:
      options:
        max-size: 10m
        max-file: 1
    healthcheck:
      test: >
        timeout -s 15 5 true || exit 1
      interval: 30s
      timeout: 10s
      start_period: 20s
      retries: 3
    depends_on:
      mosquitto:
        condition: service_started
        restart: true
      valkey:
        condition: service_started
        restart: true
    deploy:
      restart_policy:
        condition: any
        delay: 5s
      resources:
        limits:
          cpus: '0.4'
        reservations:
          cpus: '0.3'
    labels:
      ile-autoheal: true

  # https://hub.docker.com/_/telegraf
  # https://www.influxdata.com/blog/docker-run-telegraf-as-non-root/
  telegraf:
    build:
      context: ${ILE_DIR}/ile_telegraf
      dockerfile: telegraf.Dockerfile
      args:
        ILE_NONROOT_UID: ${ILE_NONROOT_UID}
        ILE_NONROOT_GID: ${ILE_NONROOT_GID}
      no_cache: false
      pull: true
    image: ile-laptop-telegraf:0.0.1
    user: nonroot:${ILE_DOCKER_GID}
    restart: always
    network_mode: host
    ports: [ ]
    hostname: ${HOSTNAME}
    environment:
      - HOST_ETC=/hostfs/etc
      - HOST_PROC=/hostfs/proc
      - HOST_SYS=/hostfs/sys
      - HOST_VAR=/hostfs/var
      - HOST_RUN=/hostfs/run
      - HOST_MOUNT_PREFIX=/hostfs
      - ILE_TELEGRAF_AGENT_INTERVAL=${ILE_TELEGRAF_AGENT_INTERVAL}
      - ILE_TELEGRAF_HEALTH_SERVICE_ADDRESS=http://127.0.0.1:8652
      - ILE_TELEGRAF_MQTT_ADDRESS=mqtts://192.168.130.10:8883
      - ILE_TELEGRAF_MQTT_USERNAME=${ILE_MQTT_USERNAME}
      - ILE_TELEGRAF_MQTT_PASSWORD=${ILE_MQTT_PASSWORD}
    volumes:
      - /:/hostfs:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${ILE_DIR}/ile_telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - ${ILE_DIR}/ile_telegraf/telegraf-writer.conf:/etc/telegraf/telegraf.d/telegraf-writer.conf:ro
      - ${ILE_DIR}/ile_telegraf/telegraf-nvidia.conf:/etc/telegraf/telegraf.d/telegraf-nvidia.conf:ro
      - ${ILE_DIR}/ile_telegraf/telegraf-noncloud.conf:/etc/telegraf/telegraf.d/telegraf-noncloud.conf:ro
      - ${ILE_DIR}/ile_telegraf/telegraf-power-supply.conf:/etc/telegraf/telegraf.d/telegraf-power-supply.conf:ro
      - ${ILE_DIR}/ile_telegraf/power_supply_info.sh:/scripts/power_supply_info.sh:ro
      - ${ILE_DIR}/ile_telegraf/uevent_to_logfmt.awk:/scripts/uevent_to_logfmt.awk:ro
      - ${PWD}/tls/${ILE_ENV}/ca.pem:/etc/telegraf/ca.crt:ro
      - ${PWD}/tls/${ILE_ENV}/laptop.pem:/etc/telegraf/server.crt:ro
      - ${PWD}/tls/${ILE_ENV}/laptop-key.pem:/etc/telegraf/server.key:ro
    security_opt:
      # https://github.com/influxdata/telegraf/issues/6574
      - apparmor:unconfined
    logging:
      options:
        max-size: 10m
        max-file: 1
    healthcheck:
      # https://github.com/influxdata/telegraf/blob/release-1.28/plugins/outputs/health/README.md
      test: (timeout -s 15 5 curl -f http://127.0.0.1:8652 && timeout -s 15 5 /usr/bin/nvidia-smi -q -x) || exit 1
      interval: 30s
      timeout: 10s
      start_period: 20s
      retries: 3
    depends_on:
      mosquitto:
        condition: service_started
        restart: true
    deploy:
      restart_policy:
        condition: any
        delay: 5s
      resources:
        limits:
          cpus: '0.4'
        reservations:
          cpus: '0.3'
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]
    labels:
      ile-autoheal: true

  # https://github.com/willfarrell/docker-autoheal
  autoheal:
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '0.4'
        reservations:
          cpus: '0.3'
    environment:
      AUTOHEAL_CONTAINER_LABEL: ile-autoheal
    image: willfarrell/autoheal:latest
    network_mode: none
    restart: always
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock
